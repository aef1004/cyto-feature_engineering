---
title: "BCG vs. PBS Mtb Infection"
author: "Amy Fox"
output: html_document
---

This dataset includes mice that were vaccinated with either PBS (control) or BCG. 12 weeks later these mice were infected with *Mycobacterium tuberculosis*. They were evaluated via CFUs for bacterial burden and flow cytometry for immune populations 30, 60, and 90 days post-infection. A Cytek Aurora was used to collect the flow cytometry data.

Data Manipulations
- removed CD69 and FoxP3 markers because spillover
- removed D30 PBS D mouse because outlier

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, the packages must be loaded.
```{r warning= FALSE}
library(openCyto)
library(flowClust)
library(data.table)
library(flowCore)
library(ggcyto)
library(pheatmap)
library(stringr)
library(tidyr)
library(readxl)
library(gridExtra)
library(ggcorrplot)
library(tidyverse)
library(scales)
library(viridis)
library(superheat)
library(kableExtra)
library(ggpubr)
library(broom)
```

I have created a few functions to make it easier to analyze the data.

- `clean_FMO_after_gate`: renames the columns; it also removes SSC boundary effects
- `statSmoothFunc`: modified from <https://gist.github.com/kdauria/524eade46135f6348140> to add $r^2$ to correlation plots [see my comment from "BCG_Survival.Rmd"]
- `stat_smooth_func`: modified from <https://gist.github.com/kdauria/524eade46135f6348140> to add $r^2$ to correlation plots
- `as.numeric.factor`: convert the factors for the marker names into numeric for plotting [see my comment from "BCG_Survival.Rmd"]
- `viridis_colors`: vector of the colors used for most plots

```{r}

clean_FMO_after_gate <- function(FMO_df) {
  FMO_df %>%
  select(ends_with("-A"), -`FSC-A`, `SSC-A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC-A",
         `CD44` = "APC-Fire 750-A",
        `CD103` =  "APC-R700-A",       
         `CD3` = "Alexa Fluor 532-A",
         `Sca1` = "BB515-A",
         `IL_10` = "BV421-A",
         `CD4` = "BV480-A",
         `CD69` = "BV510-A",
         `CD8` = "BV570-A", 
         `CTLA4` = "BV605-A",
         `CD27` = "BV650-A",
         `CD153` = "BV711-A",
         `KLRG1` = "BV785-A",
         `IL_17` = "PE-A",
         `CD122` = "PE-Cy5-A",
         `IFN` = "PE-Cy7-A", 
         `CD62L` = "PE-Dazzle594-A",
         `TNF` = "Pacific Blue-A", 
         `CD28` = "PE-Cy5.5-A",
         `PD1` = "PerCP-eFluor 710-A")  %>%
   na.omit()%>%
  dplyr::filter(`SSC-A` != max(`SSC-A`))

}


# taken from https://gist.github.com/kdauria/524eade46135f6348140
stat_smooth_func <- function(mapping = NULL, data = NULL,
                        geom = "smooth", position = "identity",
                        ...,
                        method = "auto",
                        formula = y ~ x,
                        se = TRUE,
                        n = 80,
                        span = 0.75,
                        fullrange = FALSE,
                        level = 0.95,
                        method.args = list(),
                        na.rm = FALSE,
                        show.legend = NA,
                        inherit.aes = TRUE,
                        xpos = NULL,
                        ypos = NULL) {
  layer(
    data = data,
    mapping = mapping,
    stat = StatSmoothFunc,
    geom = geom,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      method = method,
      formula = formula,
      se = se,
      n = n,
      fullrange = fullrange,
      level = level,
      na.rm = na.rm,
      method.args = method.args,
      span = span,
      xpos = xpos,
      ypos = ypos,
      ...
    )
  )
}

StatSmoothFunc <- ggproto("StatSmooth", Stat,
                      
                      setup_params = function(data, params) {
                        # Figure out what type of smoothing to do: loess for small datasets,
                        # gam with a cubic regression basis for large data
                        # This is based on the size of the _largest_ group.
                        if (identical(params$method, "auto")) {
                          max_group <- max(table(data$group))
                          
                          if (max_group < 1000) {
                            params$method <- "loess"
                          } else {
                            params$method <- "gam"
                            params$formula <- y ~ s(x, bs = "cs")
                          }
                        }
                        if (identical(params$method, "gam")) {
                          params$method <- mgcv::gam
                        }
                        
                        params
                      },
                      
                      compute_group = function(data, scales, method = "auto", formula = y~x,
                                               se = TRUE, n = 80, span = 0.75, fullrange = FALSE,
                                               xseq = NULL, level = 0.95, method.args = list(),
                                               na.rm = FALSE, xpos=NULL, ypos=NULL) {
                        if (length(unique(data$x)) < 2) {
                          # Not enough data to perform fit
                          return(data.frame())
                        }
                        
                        if (is.null(data$weight)) data$weight <- 1
                        
                        if (is.null(xseq)) {
                          if (is.integer(data$x)) {
                            if (fullrange) {
                              xseq <- scales$x$dimension()
                            } else {
                              xseq <- sort(unique(data$x))
                            }
                          } else {
                            if (fullrange) {
                              range <- scales$x$dimension()
                            } else {
                              range <- range(data$x, na.rm = TRUE)
                            }
                            xseq <- seq(range[1], range[2], length.out = n)
                          }
                        }
                        # Special case span because it's the most commonly used model argument
                        if (identical(method, "loess")) {
                          method.args$span <- span
                        }
                        
                        if (is.character(method)) method <- match.fun(method)
                        
                        base.args <- list(quote(formula), data = quote(data), weights = quote(weight))
                        model <- do.call(method, c(base.args, method.args))
                        
                        m = model
                        eq <- substitute(~~italic(r)^2~"="~r2, 
                                         list(a = format(coef(m)[1], digits = 3), 
                                              b = format(coef(m)[2], digits = 3), 
                                              r2 = format(summary(m)$r.squared, digits = 3)))
                        func_string = as.character(as.expression(eq))
                        
                        if(is.null(xpos)) xpos = min(data$x)*0.9
                        if(is.null(ypos)) ypos = max(data$y)*0.9
                        data.frame(x=xpos, y=ypos, label=func_string)
                        
                      },
                      
                      required_aes = c("x", "y")
)

viridis_colors <- c("#3F4788FF", "#56C667FF")


as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

```

## Initial gating of FMOs

Read in the initial gating strategy, which gates to live lymphocytes, into a `gatingTemplate` class.

```{r}
# Identify the file with the gating strategy 
ws <- list.files("../Data/flow/BCG_v_PBS", 
                 pattern = "AmyGating_intracellular.csv", 
                 full = TRUE)
ws
```

```{r}
# View this template
dtTemplate <- fread(ws)
dtTemplate
```

```{r message = FALSE, warning = FALSE}
# Read in the gating strategy to a 'gatingTemplate' object
initial_gate <- gatingTemplate(ws) 
plot(initial_gate)
```

Read in the flow cytometry data from the FMO experiments.

```{r}
# Identify the file names of all 20 FCS flow cytometry experiments to 
# read in. 
FMO_fcsFiles <- list.files("../Data/flow/BCG_v_PBS/Tcell/FMOs", 
                       pattern = ".fcs", full = TRUE)
FMO_fcsFiles
```

```{r}
# Read these files into a 'ncdfFlowSet' object. This will taken a minute
# or so to run. The resulting 'ncdfFlowset' object contains row names with the 
# individual samples and column names with the markers/parameters used in the flow cytometer.
ncfs_FMO <- read.ncdfFlowSet(FMO_fcsFiles) 
ncfs_FMO
```

Apply the initial gating to filter the data to only measurements on live lymphocyte cells.

```{r}
# Convert to a 'GatingSet' object, so we can apply the initial gating to this data.
gs_FMO <- GatingSet(ncfs_FMO)
gs_FMO
```

```{r fig.height = 8, fig.width = 4}
# Apply the initial gating to this data, to filter to only measurements
# on live lymphocyte cells. This may take a minute.
gating(initial_gate, gs_FMO)
## [Amy, for the singlets gating, we're getting a warning about 'rlm' failing to 
## converge. Let's see if we can fix this error message. I think there's probably 
## an option we can change for the gating function for that step---if we have it 
## try more iterations before it decides it can't converge, we should be able
## to resolve this warning. Gating for 'lymph' and 'live' look fine.]

# You can plot the results of this gating with `plotGate`. For example, to plot
# the gating for the first sample, run:
plotGate(gs_FMO[[1]])
```

## Convert data to "tidy data" format

Now that the initial gating has been applied, to limit the data to measurements of 
live, singlet lymphocyte cells, we convert the data to a "tidy data" format
[ref on tidy data], to allow us to work with "tidyverse" tools for further 
analysis and visualization.

```{r}
# Pull out the data from the 'live' node of the gating set (the last node
# in the initial gating strategy).
FMO_gated_data <- getData(gs_FMO, "live") %>% 
  as.flowSet() 

# Write a function to extract data from an item of a 'flowSet' object
library(tibble)
tidy_flow_item <- function(flowSet_item){
  flowSet_item %>% 
    Biobase::exprs() %>% 
    tibble::as_tibble()
}

# Create a function that applies this to all items in a 'flowSet' object
tidy_flow_set <- function(flowSet){
  flow_set <- flowCore::fsApply(x = flowSet, 
                                FUN = tidy_flow_item)
  flow_set <- dplyr::bind_rows(flow_set, .id = "filename")
}
```

Apply this function to the 'flowSet' of gated FMO data:

```{r}
FMO_gated_data <- tidy_flow_set(FMO_gated_data)
FMO_gated_data
```


```{r}
# confirm that all of the files were read in correctly
unique(FMO_gated_data$filename)
```

[Let's clean up this file so we don't have redos, instead just a clean flow
through our final code.]

```{r}
# I accidently got CD4 into the CD4 FMO, so I had to redo it. I also tried CD69 to see if it was experiment-dependent, but CD69 problems are due to spillover

# Add in the updated FMOS
FMO_fcsFiles_redo <- list.files("../Data/flow/BCG_v_PBS/Tcell/FMOs/June6_Redo", 
                       pattern = ".fcs", full = TRUE)

ncfs_FMO_redo <- read.ncdfFlowSet(FMO_fcsFiles_redo) 

# apply gating set
gs_FMO_redo <- GatingSet(ncfs_FMO_redo)

# gate the samples
gating(initial_gate, gs_FMO_redo)
```

```{r}
# Pull out the data
FMO_gated_data_redo <- getData(gs_FMO_redo, "live") %>% 
  as.flowSet() 

FMO_gated_df_redo <- tidy_flow_set(FMO_gated_data_redo)
```

[can delete this?]
 dplyr::rename_all(list(~ stringr::str_replace_all(., "[\\s|\\-]", replacement = "."))) %>% 
  This was part of the redo 
```{r}
# when I redid the FMOs, I used lowercase for naming Zombie, so must convert to uppercase to match the previous samples
FMO_gated_df_redo <- FMO_gated_df_redo %>%
  dplyr::select(-`SSC-B-H`, - `SSC-B-A`) %>%
  dplyr::rename("Zombie NIR-A" = "Zombie Nir-A",
         "Zombie NIR-H" = "Zombie Nir-H")

# combine the new and old FMOs
FMO_gated_data <- rbind(FMO_gated_data, FMO_gated_df_redo)

```

This visualization is to look at the initial gating of the FMOs to ensure that the gates are placed correctly.
```{r fig.height = 8, fig.width = 4}
plotGate(gs_FMO[[3]])
```



[Amy, what is it about the above plot that we want to tweak through the code in the next
few sections? I'm thinking there definitely should be a way to shorten the following code, 
but I want to make sure I understand what we're aiming for before I take a crack.]

[Reply to Brooke: I want to automate it so that I don't have to plot each individual FMO like below. I attempted to do this in the code above, but I wasn't able to get it to work. The problem is that each filename has a different threshold, so I don't know how to map it correctly that way...]

Pull out the individual FMOS

```{r}

CD3_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD3_20190218_153937_Unmixed.fcs")

CD4_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD4_June_6_Redo_Unmixed.fcs")

CD8_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD8_20190218_154138_Unmixed.fcs")

CD27_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD27_20190218_154154_Unmixed.fcs")

CD28_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD28_20190218_154012_Unmixed.fcs")

CD44_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD44_20190218_154054_Unmixed.fcs")

CD62L_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD62L_20190218_153953_Unmixed.fcs") 

CD69_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD69_June_6_Redo_Unmixed.fcs")

CD103_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD103_20190218_154045_Unmixed.fcs")

CD122_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD122_20190218_154003_Unmixed.fcs")

CD153_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD153_20190218_154205_Unmixed.fcs")

CTLA4_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CTLA4_20190218_154146_Unmixed.fcs")

FoxP3_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_FoxP3_20190218_154037_Unmixed.fcs") 

IFN_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IFN-G_20190218_154029_Unmixed.fcs")

IL_10_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IL-10_20190218_154102_Unmixed.fcs") 

IL_17_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IL-17_20190218_153945_Unmixed.fcs")

KLRG1_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_KLRG1_20190218_154214_Unmixed.fcs") 

PD1_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_PD1_20190218_154021_Unmixed.fcs")

Sca1_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_Sca1_20190218_153845_Unmixed.fcs")

TNF_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_TNF-a_20190218_154111_Unmixed.fcs")
```

Feature engineering FMOs and plot

Try messing with hexbins
```{r fig.width = 8, fig.height= 6 warning=FALSE}
p1 <-  ggplot(CD3_FMO, aes(x = CD3, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD3_FMO$CD3, 0.99)) +
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p2 <- ggplot(CD4_FMO, aes(x = CD4, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD4_FMO$CD4, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p3 <- ggplot(CD8_FMO, aes(x = CD8, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD8_FMO$CD8, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

# this plot is removed because we are not going to be using this marker
p4 <- ggplot(FoxP3_FMO, aes(x = FoxP3, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(FoxP3_FMO$FoxP3, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p5 <- ggplot(CD27_FMO, aes(x = CD27, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD27_FMO$CD27, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p6 <- ggplot(CD28_FMO, aes(x = CD28, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD28_FMO$CD28, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p7 <- ggplot(CD44_FMO, aes(x = CD44, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD44_FMO$CD44, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p8 <- ggplot(IL_10_FMO, aes(x = IL_10, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(IL_10_FMO$IL_10, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p9 <- ggplot(CD62L_FMO, aes(x = CD62L, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD62L_FMO$CD62L, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

# this plot is removed because we are not going to be using this marker
p10 <- ggplot(CD69_FMO, aes(x = CD69, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD69_FMO$CD69, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p11 <- ggplot(CD103_FMO, aes(x = CD103, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD103_FMO$CD103, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p12 <- ggplot(CD122_FMO, aes(x = CD122, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD122_FMO$CD122, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p13 <- ggplot(CD153_FMO, aes(x = CD153, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD153_FMO$CD153, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p14 <- ggplot(CTLA4_FMO, aes(x = CTLA4, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CTLA4_FMO$CTLA4, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p15 <- ggplot(IL_17_FMO, aes(x = IL_17, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(IL_17_FMO$IL_17, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p16 <- ggplot(IFN_FMO, aes(x = IFN, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(IFN_FMO$IFN, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p17 <- ggplot(TNF_FMO, aes(x = TNF, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(TNF_FMO$TNF, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p18 <- ggplot(KLRG1_FMO, aes(x = KLRG1, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(KLRG1_FMO$KLRG1, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p19 <- ggplot(PD1_FMO, aes(x = PD1, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(PD1_FMO$PD1, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p20 <- ggplot(Sca1_FMO, aes(x = Sca1, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(Sca1_FMO$Sca1, 0.99))+
  theme_gray() +
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20)) +
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


library(grid)
grid.arrange(p1, p2, p3, p5, p6, p7, p8, p9,
             p11, p12, p13, p14, p15, p16, p17, p18, p19, p20, 
             nrow = 5, left = textGrob("SSC-A", rot = 90, vjust = 1, gp=gpar(fontsize=24, lineheight=1)))
```

Gating the sample data

I checked that all D30, D60, and D90 samples have Zombie and will run all the way through the gating when separated by day. Looking at the data, some of them are labeled Zombie NIR-A and Zombie Nir-A which means that they are not recognized as the same. - D90 has uncapitalized. I will need to read them in separately and then rename one of the two so that the cases match

```{r warning=FALSE, fig.height = 2, fig.width=2}

fcsFiles <- list.files("../Data/flow/BCG_v_PBS/Tcell/", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
ncfs <- read.ncdfFlowSet(fcsFiles) 

# apply gating set
gs <- GatingSet(ncfs)

# gate the samples
gating(initial_gate, gs)

# View the gates
plotGate(gs[[12]])





# Pull out the gated data
gated_data <- getData(gs, "live") %>% 
  as.flowSet() 

# plot the gates to make sure they look okay
for (i in 1:length(gs)) {
  plotGate(gs[[i]])
}

# read in the D90 data
D90_ws <- list.files("../Data/flow/BCG_v_PBS", 
                     pattern = "AmyGating_intracellular_D90.csv", full = TRUE)

D90_initial_gate <- gatingTemplate(D90_ws, autostart = 1L) 

D90_fcsFiles <- list.files("../Data/flow/BCG_v_PBS/Tcell/D90", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
D90_ncfs <- read.ncdfFlowSet(D90_fcsFiles) 

# apply gating set
D90_gs <- GatingSet(D90_ncfs)

# gate the samples
gating(D90_initial_gate, D90_gs)

# Pull out the data
D90_gated_data <- getData(D90_gs, "live") %>% 
  as.flowSet() 

# initialize the gated data df
all_gated_df = data.frame()

# convert the gated flow files to dataframes and add a filename column
for (i in 1:length(gated_data)) {
  all_data <- gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(gated_data[i])) 

  all_gated_df <- rbind(all_gated_df, all_data)
}

# initialize the D90 gated data df
D90_all_gated_df = data.frame()

# convert the gated flow files to dataframes and add a filename column
for (i in 1:length(D90_gated_data)) {
  D90_all_data <- D90_gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(D90_gated_data[i])) 

  D90_all_gated_df <- rbind(D90_all_gated_df, D90_all_data)
}

# remove parameters that are not found in D30 and D60 data and rename the D90 Zombie column
D90_all_gated_df <- D90_all_gated_df %>%
  select(Time, SSC.H, FSC.H, ends_with(".A"), 
         `FSC.A`, `SSC.A`, -`SSC.B.A`, filename) %>%
  rename("Zombie.NIR.A" = "Zombie.Nir.A")

# combine the D30, D60, and D90 data into 1 dataframe
all_gated_df <- rbind(all_gated_df, D90_all_gated_df)

# confirm that all of the data is here
unique(all_gated_df$filename)

ggcyto(gs[[3]], aes(x = `FSC.A`, y = `FSC.H`)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis_c() +
  xlim(-100, 4000000) +
  geom_gate("singlets") +
  xlab("FSC-A") +
  ylab("FSC-H") +
  ggtitle("Singlets") +
  theme_gray() +
  geom_stats() + 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))

ggcyto(gs[[3]], aes(x = `FSC-A`, y = `SSC-A`)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis_c() +
  geom_gate("lymph") +
  ylim(-100, 4000000) + 
  xlab("FSC-A") +
  ylab("SSC-A") +
  ggtitle("Leukocytes") +
  theme_gray() +
  geom_stats()+ 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))

ggcyto(gs[[3]], aes(x = `Zombie Nir-A`)) + 
  geom_density() + 
  geom_gate("live") + 
  xlim(-100,50000) + 
  xlab("Zombie NIR-A") +
  ylab("Density") +
  ggtitle("Live") +
  theme_gray() +
  geom_stats() +
  labs_cyto("both") + 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))

```

Feature cut the data to get all of the possible populations for each file with the cell count and number of cells. Feature engineering is based on the 99%.

Remove FoxP3
Remove CD69 - spreading from Sca1 makes the marker unusable
Remove D30 PBS D - flow cytometry outlier, both within group, timepoint, and all samples
```{r}

all_gated <- all_gated_df %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 

```

Data visualization

We first want to view all of the different cell phenotypes within the data, and then we can filter the data to see the ones that we're interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.

```{r fig.height = 2.25, fig.width = 1.75}
# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

supp_1 <-pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE, legend = F, fontsize = 6, angle_col = 45, width = 2, height = 1.5) %>%
  print()


# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))


```

Want to add annotations to the phenotype plot

- lineage
- cell
- resident

based on expression of different markers. The phenotype plot is then arranged by lineage, cell and resident cells and split by the lineage (I should try to find a way to do this automatically).

```{r}

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot,  gaps_row = c(17, 29, 35),
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)
```

Want to get the percentages added so can plot the percentages with the new 

```{r}
# change the population rownames to column 
phenotype_data <- phenotype_data %>%
  rownames_to_column(var = "population")

# convert the marker columns of factor class into numeric
all_gated <- all_gated %>%
  mutate_if(is.factor, ~as.numeric.factor(.)) 

# add the percentages from original data to the populations of filtered data
add_perc <- left_join(phenotype_data, all_gated)

# expand the data so can see which files have 0 cells in a phenotype
all_options <- expand(add_perc, population, filename)

# add the populations back 
add_pops <- left_join(all_options, phenotype_data)

# add the percentages back
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0))) 

# confirm that the populations were added correctly
unique(sample_populations_all_groups$population)

```

Data Visualization

 - Population correlation Plot

```{r fig.height = 4, fig.width = 4}

# correlation plot without the name "pop"
corr <- sample_populations_all_groups %>%
  mutate(population= str_replace(population, "Pop", "")) %>%
  spread(key = population, value = percentage) %>%
  select(-filename) %>%
  select(c(paste0(1:nrow(phenotype_data))))

corr <- round(cor(corr), 1)

# plot the population correlation plot separated by the lineages
superheat(corr,  row.title = "Populations", column.title = "Populations",  column.title.size = 8, row.title.size = 8, bottom.label.col = c(rep("darkturquoise", 17), rep("plum3", 12), rep("hotpink", 6), rep("orange", 1)), left.label.col = c(rep("darkturquoise", 17), rep("plum3", 12), rep("hotpink", 6), rep("orange", 1)), bottom.label.size = .05, left.label.size = .05, bottom.label.text.size = 3, left.label.text.size = 3)


```

Data visualization

- time series
- treated v. untreated

```{r fig.width = 6, fig.height= 3}
color_for_facets <- phenotype_data %>%
  select(lineage, population) %>%
  mutate(col = ifelse(lineage == "Double Negative", "darkturquoise", 
                      ifelse(lineage == "T Helper", "plum3",
                             ifelse(lineage == "Cytotoxic T", "hotpink", 
                                    ifelse(lineage == "Double Positive", "orange", "brown")))))


# take the data for filtered populations and rename so that plots are pretty
pops_for_plots_average <- sample_populations_all_groups %>%
  separate(filename, into = c("Timepoint", "Mouse", "Group", "Number"), sep = "_") %>%
  dplyr::group_by(population, Timepoint, Group) %>%
  dplyr::mutate(average_percent = mean(percentage)) %>%
  select(-Number, -percentage, -Mouse) %>%
  ungroup() %>%
  unique() %>%
  dplyr::mutate(Group = str_replace(Group, "1", "PBS"),
         Group = str_replace(Group, "2", "BCG")) %>%
  dplyr::mutate(Timepoint = str_replace(Timepoint, "D30", "30"),
         Timepoint = str_replace(Timepoint, "D60", "60"),
         Timepoint = str_replace(Timepoint, "D90", "90")) %>%
  mutate(Group = str_replace(Group, "PBS", "Control"),
         Group = str_replace(Group, "BCG", "Vaccinated"))

facets_for_timeseries <- left_join(pops_for_plots_average, color_for_facets, by = "population")

# convert populations to factor to put in order for the plot
facets_for_timeseries$population <-  factor(facets_for_timeseries$population, 
                                    levels = paste0("Pop", c(1:length(unique(facets_for_timeseries$population)))))


ggplot(facets_for_timeseries, aes(x = factor(Timepoint, levels = c("30", "60", "90")),
                                 y = average_percent, group = Group, color = Group)) +
  geom_rect(aes(fill = col),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = 0.2) +
  scale_fill_identity() +
  geom_point() +
  geom_line() +
  facet_wrap("population", scales = "free", ncol = 9) +
  xlab("Days Post-Infection") +
  ylab("Average Percent of Total Live Leukocytes") +
  scale_color_manual(values = c("black", "white")) +
  theme_gray() +
    theme(axis.text.x = element_text(angle = 45, size = 13, hjust = 1),
        axis.text.y = element_text(size = 13),
        strip.text.x = element_text(size = 10),
        axis.title = element_text(size = 17),
        title = element_text(size = 20),
        legend.text = element_text(size=18),
        legend.key.size = unit(1.5, "line"))




```

Extra visualizations
```{r fig.width = 6.5, fig.height= 4}
# Vaccinated v. unvaccinated for Day 30 bar
facets_for_vacc_v_unvacc <- facets_for_timeseries %>%
  filter(Timepoint == 30)
  
#adding geom_rect messes the data up
ggplot(facets_for_vacc_v_unvacc, aes(x = Group,
                                 y = average_percent, group = Group, fill = Group)) +
  geom_rect(aes(fill = c(col)),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = .6) +
  geom_bar(stat = "identity") +
  facet_wrap("population", scales = "free", ncol = 9) +
  scale_fill_manual(values = c("Control" = "black", "Vaccinated" = "white", "darkturquoise" = "darkturquoise",  "hotpink" = "hotpink","orange" = "orange","plum3" = "plum3")) +
  xlab("Vaccination Status") +
  ylab("Average Percent of Cells") +
  ggtitle("Lung Cell Percentage of Total Live Leukocytes") +
  theme_gray() +
    theme(axis.text.x = element_text(angle = 40, size = 13, hjust = 1),
        axis.text.y = element_text(size = 13),
        strip.text.x = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20),
        legend.text = element_text(size=18),
        legend.key.size = unit(1.5, "line"),
        legend.position = "none")


# boxplot
facets_for_boxplot <- sample_populations_all_groups %>%
  separate(filename, into = c("Timepoint", "Mouse", "Group", "Number"), sep = "_") %>%
  dplyr::group_by(population, Timepoint, Group) %>%
  dplyr::mutate(average_percent = mean(percentage)) %>%
  select(-Number, -Mouse) %>%
  ungroup() %>%
  unique() %>%
  dplyr::mutate(Group = str_replace(Group, "1", "PBS"),
         Group = str_replace(Group, "2", "BCG")) %>%
  dplyr::mutate(Timepoint = str_replace(Timepoint, "D30", "30"),
         Timepoint = str_replace(Timepoint, "D60", "60"),
         Timepoint = str_replace(Timepoint, "D90", "90")) %>%
  filter(Timepoint == 30) %>%
  mutate(Group = str_replace(Group, "PBS", "Control"),
         Group = str_replace(Group, "BCG", "Vaccinated"))

# add background colors
facets_for_boxplot <- left_join(facets_for_boxplot, color_for_facets, by = "population")

# convert populations to factor to put in order for the plot
facets_for_boxplot$population <-  factor(facets_for_boxplot$population, 
                                    levels = paste0("Pop", c(1:length(unique(facets_for_boxplot$population)))))


ggplot(facets_for_boxplot, aes(x = Group,
                                 y = percentage, group = Group, fill = Group)) +
  geom_rect(aes(fill = c(col)),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = .2) +
  geom_boxplot() +
  facet_wrap("population", scales = "free", ncol = 9) +
  scale_fill_manual(values = c("Control" = "black", "Vaccinated" = "white", "darkturquoise" = "darkturquoise",  "hotpink" = "hotpink","orange" = "orange","plum3" = "plum3")) +
  xlab("Vaccination Status") +
  ylab("Percent of Cells") +
  ggtitle("Lung Cell Percentage of Total Live Leukocytes") +
  theme_gray() +
    theme(axis.text.x = element_text(angle = 40, size = 13, hjust = 1),
        axis.text.y = element_text(size = 13),
        strip.text.x = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20),
        legend.text = element_text(size=18),
        legend.key.size = unit(1.5, "line"),
        legend.position = "none")


ggplot(facets_for_boxplot, aes(x = Group,
                                 y = percentage, group = Group, fill = Group)) +
  geom_rect(aes(fill = c(col)),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = .2) +
  geom_violin() +
  facet_wrap("population", scales = "free", ncol = 9) +
  scale_fill_manual(values = c("Control" = "black", "Vaccinated" = "white", "darkturquoise" = "darkturquoise",  "hotpink" = "hotpink","orange" = "orange","plum3" = "plum3")) +
  xlab("Vaccination Status") +
  ylab("Percent of Cells") +
  ggtitle("Lung Cell Percentage of Total Live Leukocytes") +
  theme_gray() +
    theme(axis.text.x = element_text(angle = 40, size = 13, hjust = 1),
        axis.text.y = element_text(size = 13),
        strip.text.x = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20),
        legend.text = element_text(size=18),
        legend.key.size = unit(1.5, "line"),
        legend.position = "none")
```


  geom_rect(aes(fill = c(col)),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = .6) +geom_rect(aes(fill = col),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = 0.2) +
Data Visualization

- CFU Correlation

```{r fig.width = 3.5, fig.height= 3.5}

# read in the CFU data
CFUs <- read_xlsx("../Data/M.smeg_CFU.xlsx") %>%
  dplyr::filter(Organ == "Lung") %>%
  dplyr::filter(Group == "Group1" | Group == "Group2")

# clean the flow data and prepare to join with CFU
pops_for_CFUs <- sample_populations_all_groups %>%
  separate(filename, into = c("Timepoint", "Mouse", "Group", "Number"), sep = "_") %>%
  dplyr::mutate(Timepoint = str_replace(Timepoint, "D", "")) %>%
  dplyr::mutate(Timepoint = as.numeric(Timepoint)) %>%
  unite(Group, c(Mouse, Group)) %>%
  dplyr::mutate(Group = str_replace(Group, "_", "")) 

# join together the CFU data and the population data
pops_CFUs <- inner_join(pops_for_CFUs, CFUs, by = c("Group", "Number", "Timepoint")) 

facets_for_CFUs <- left_join(pops_CFUs, color_for_facets, by = "population")

facets_for_CFUs$population <-  factor(facets_for_CFUs$population, 
                                    levels = paste0("Pop", c(1:length(unique(facets_for_CFUs$population)))))

ggplot(facets_for_CFUs, aes(percentage, CFU)) +
  geom_rect(aes(fill = col),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = 0.05) + 
  scale_fill_identity() +
  geom_point(color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "#3F4788FF") +
  facet_wrap(~population, scales = "free_x", ncol = 6) +
  stat_smooth_func(geom= "text", method = "lm", hjust = 0, parse = TRUE, color = "white") +
  xlab("Percentage of Cells") +
  ylab("log10 CFU") +
  ggtitle("Population and CFU Linear regression") +
  theme(axis.text.x = element_text(size = 9, hjust = 1),
        axis.text.y = element_text(size = 9),
        axis.title = element_text(size = 15),
        title = element_text(size = 17))

fitted_models <- facets_for_CFUs %>% 
  group_by(population) %>% 
  do(model = lm(percentage ~ CFU, data = .)) %>%
  tidy(model) %>%
  filter(term == "CFU") %>%
  select(population, p.value) %>%
  rename(p.value = p.value) %>%
  ungroup()

fitted_models %>%
  mutate(p.val.adj = p.adjust(fitted_models$p.value, "BH")) %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) %>%
  kable(align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  row_spec(0:nrow(fitted_models), color = "black")

# me testing out

fitted_models <- facets_for_CFUs %>% 
  group_by(population) %>% 
  do(model = lm(percentage ~ CFU, data = .)) %>%
  glance(model) %>%
  select(population, r.squared, p.value) %>%
  ungroup()

fitted_models %>%
  mutate(p.val.adj = p.adjust(fitted_models$p.value, "BH")) %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "r squared" = r.squared,
         "Adjusted p-value" = p.val.adj) %>%
  kable(align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 15) %>%
  row_spec(0:nrow(fitted_models), color = "black")

```

Different timepoints for hypothesis
```{r}

# D30
facets_for_CFUs_D30 <- facets_for_CFUs %>%
  filter(Timepoint == 30)

ggplot(facets_for_CFUs_D30, aes(percentage, CFU)) +
  geom_rect(aes(fill = col),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = 0.2) + 
  scale_fill_identity() +
  geom_point(color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "#3F4788FF") +
  facet_wrap(~population, scales = "free_x", ncol = 9) +
  stat_smooth_func(geom= "text", method = "lm", hjust = 0, parse = TRUE) +
  scale_x_continuous(breaks = scales::pretty_breaks(3)) +
  xlab("Percentage of Cells") +
  ylab("log10 CFU") +
  ggtitle("Day 30: Population and CFU Linear regression") +
  theme(axis.text.x = element_text(size = 9, hjust = 1),
        axis.text.y = element_text(size = 9),
        axis.title = element_text(size = 15),
        title = element_text(size = 17))

# D60
facets_for_CFUs_D60 <- facets_for_CFUs %>%
  filter(Timepoint == 60)

ggplot(facets_for_CFUs_D60, aes(percentage, CFU)) +
  geom_rect(aes(fill = col),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = 0.2) + 
  scale_fill_identity() +
  geom_point(color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "#3F4788FF") +
  facet_wrap(~population, scales = "free_x", ncol = 9) +
  stat_smooth_func(geom= "text", method = "lm", hjust = 0, parse = TRUE) +
  scale_x_continuous(breaks = scales::pretty_breaks(3)) +
  xlab("Percentage of Cells") +
  ylab("log10 CFU") +
  ggtitle("Day 60: Population and CFU Linear regression") +
  theme(axis.text.x = element_text(size = 9, hjust = 1),
        axis.text.y = element_text(size = 9),
        axis.title = element_text(size = 15),
        title = element_text(size = 17))

# D90
facets_for_CFUs_D90 <- facets_for_CFUs %>%
  filter(Timepoint == 90)

ggplot(facets_for_CFUs_D90, aes(percentage, CFU)) +
  geom_rect(aes(fill = col),xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf, alpha = 0.2) + 
  scale_fill_identity() +
  geom_point(color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "#3F4788FF") +
  facet_wrap(~population, scales = "free_x", ncol = 9) +
  stat_smooth_func(geom= "text", method = "lm", hjust = 0, parse = TRUE) +
  scale_x_continuous(breaks = scales::pretty_breaks(3)) +
  xlab("Percentage of Cells") +
  ylab("log10 CFU") +
  ggtitle("Day 90: Population and CFU Linear regression") +
  theme(axis.text.x = element_text(size = 9, hjust = 1),
        axis.text.y = element_text(size = 9),
        axis.title = element_text(size = 15),
        title = element_text(size = 17))
```


Confirm pipeline populations with manual gating

```{r}

# read in and clean manual gating percentage data
manual_gating_pop3 <- read_xlsx("../Data/flow/BCG_v_PBS/manual_gating_pop3.xlsx") %>%
  dplyr::rename(`Sample` = "Sample:",
         live_leuk = "Singlets/Leukocytes/Live | Count",
         pop3 = "Singlets/Leukocytes/Live/CD3+/CD44+/Sca1+/IFN+/CD4-/CD8-/CD27-/CD28-/CD62L-/CD103-/CD122-/CD153-/CTLA4-/IL10-/IL17-/KLRG1-/PD1-/TNF- | Count",
         percent_manual = "Percentage") %>%
  filter(Sample != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Sample = str_replace_all(Sample, " ", "_")) %>%
  separate(Sample, into = c("Timepoint", "Organ", "group", "Group", "Number", "Date", "random", "Unmix"), sep = "_") %>%
  mutate(Timepoint = str_replace_all(Timepoint, "D", "")) %>%
  select(Timepoint, Group, Number, percent_manual) %>%
  mutate(population = rep("Pop3", 24))

# prepare the flow CFU data for joining with manual gating
pipeline_pop3 <- pops_CFUs %>%
  dplyr::filter(population == "Pop3") %>%
  mutate(Group = str_replace_all(Group, "Group", "")) %>%
  mutate(Timepoint = as.character(Timepoint)) %>%
  select(-Organ, -CFU) %>%
  dplyr::rename(percent_pipeline = percentage)

# should add absolute value of the percent_pipeline-percent_manual for error (abs)
# join the manual and pipeline percentage data
comparison <- full_join(manual_gating_pop3, pipeline_pop3, by = c("Timepoint", "Group", "Number", "population")) %>%
  mutate(difference = round(percent_pipeline - percent_manual, digits = 2)) %>%
  mutate(error = round(100*(percent_pipeline - percent_manual)/percent_manual, digits = 2)) %>%
  mutate(Group = str_replace_all(Group, "1", "PBS")) %>%
  mutate(Group = str_replace_all(Group, "2", "BCG")) %>%
  mutate(percent_manual = round(percent_manual, digits = 2),
         percent_pipeline = round(percent_pipeline, digits = 2)) %>%
  mutate(absolute_difference = abs(difference),
         average_difference = mean(absolute_difference)) %>%
    select(population, Timepoint, Group, Number, percent_manual, percent_pipeline, absolute_difference, average_difference) 

# print out the comparison data in a pretty table
comparison %>%
  mutate(`% Based On Manual Gating` = percent_manual,
         `% Based on Automated Pipeline` = percent_pipeline,
         `Absolute Difference` = absolute_difference,
         `Average Difference` = average_difference) %>%
  mutate(Group = str_replace(Group, "PBS", "Control"),
         Group= str_replace(Group, "BCG", "Vaccinated")) %>%
  select(Timepoint, Group, Number, `% Based On Manual Gating`, `% Based on Automated Pipeline`, `Absolute Difference`, `Average Difference`) %>%
  kable(align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 25) %>%
  row_spec(0:nrow(comparison), color = "black")

# compare the two gating types with manual v. pipeline plot
ggplot(comparison, aes(x = percent_pipeline, y = percent_manual)) +
  geom_point(size = 3) +
  geom_abline(slope = 1, intercept = 0, size = 1) +
  stat_cor(aes(x = percent_pipeline, y = percent_manual), data = comparison, "spearman", size = 7) +
  ggtitle("Population 3: Manual vs. Pipeline Percentage") +
  xlab("Pipeline Percent") +
  ylab("Manual Percent") +
  theme_classic()+
  theme(axis.title = element_text(size = 20),
        axis.text = element_text(size = 15),
        title = element_text(size = 15))
  
```

