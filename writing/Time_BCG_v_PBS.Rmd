---
title: "Time_BCG_v_PBS"
author: "Amy Fox"
output: html_document
---

This R-Markdown tests  how long it takes to analyze the data and produce the figures.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, the packages must be loaded.
```{r warning= FALSE}

start_time <- Sys.time()

library(openCyto)
library(flowClust)
library(data.table)
library(flowCore)
library(ggcyto)
library(dplyr)
library(pheatmap)
library(stringr)
library(tidyr)
library(gridExtra)
library(tidyverse)
library(scales)
library(viridis)
```

I have created a few functions to make it easier to analyze the data.

- clean_FMO_after_gate:renames the columns; it also removes SSC boundary effects
- statSmoothFunc: copied from <https://gist.github.com/kdauria/524eade46135f6348140> to add r^2 to correlation plots
- stat_smooth_func: copied from <https://gist.github.com/kdauria/524eade46135f6348140> to add r^2 to correlation plots
- phenotype_heatmap: to create the phenotype graphs with the populations and marker expression
- as.numeric.factor: convert the factors for the marker names into numeric for plotting
```{r}

clean_FMO_after_gate <- function(FMO_df) {
  FMO_df %>%
  select(ends_with(".A"), -`FSC.A`, `SSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A")  %>%
   na.omit()%>%
  dplyr::filter(`SSC.A` != max(`SSC.A`))

}

viridis_colors <- c("#3F4788FF", "#56C667FF")

phenotype_heatmap <- function(csv_file, population_no, title) {
  pheatmap(csv_file, cluster_rows = FALSE, cluster_cols = FALSE, 
           color = viridis_colors, cellwidth = 15, cellheight = 15,
           labels_row = paste("Pop", population_no), main = title)
}

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

```

Initial gating of FMOs

If want to count the number of initial cells

FMO_gated_df_count <- data_frame()
for (i in 1:length(ncfs_FMO)) {
  FMO_data_count <- ncfs_FMO[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(ncfs_FMO[i])) 

  FMO_gated_df_count <- rbind(FMO_gated_df_count, FMO_data_count)
}
```{r}

gating_time_start <- Sys.time()
# read in the gating strategy
ws <- list.files("../data/flow/BCG_v_PBS", pattern = "AmyGating_intracellular.csv", full = TRUE)

# only for viewing that read in 
dtTemplate <- fread(ws, autostart = 1L) 

initial_gate <- gatingTemplate(ws, autostart = 1L) 

# read in the FMOs
FMO_fcsFiles <- list.files("../data/flow/BCG_v_PBS/Tcell/FMOs", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
ncfs_FMO <- read.ncdfFlowSet(FMO_fcsFiles) 



# apply gating set
gs_FMO <- GatingSet(ncfs_FMO)

# gate the samples
gating(initial_gate, gs_FMO)

# Pull out the data
FMO_gated_data <- getData(gs_FMO, "live") %>% 
  as.flowSet() 

#initialize dataframe where all data will go
FMO_gated_df = data.frame()

# convert each of the FMO files to a data frame, adding on the filename
# bind all of the FMO files into one dataframe
for (i in 1:length(FMO_gated_data)) {
  FMO_data <- FMO_gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(FMO_gated_data[i])) 

  FMO_gated_df <- rbind(FMO_gated_df, FMO_data)
}

# confirm that all of the files were read in correctly
unique(FMO_gated_df$filename)

# I accidently got CD4 into the CD4 FMO, so I had to redo it. I also tried CD69 to see if it was experiment-dependent, but CD69 problems are due to spillover

# Add in the updated FMOS
FMO_fcsFiles_redo <- list.files("../data/flow/BCG_v_PBS/Tcell/FMOs/June6_Redo", 
                       pattern = ".fcs", full = TRUE)

ncfs_FMO_redo <- read.ncdfFlowSet(FMO_fcsFiles_redo) 

# apply gating set
gs_FMO_redo <- GatingSet(ncfs_FMO_redo)

# gate the samples
gating(initial_gate, gs_FMO_redo)

# Pull out the data
FMO_gated_data_redo <- getData(gs_FMO_redo, "live") %>% 
  as.flowSet() 

FMO_gated_df_redo = data.frame()

for (i in 1:length(FMO_gated_data_redo)) {
  FMO_data_redo <- FMO_gated_data_redo[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(FMO_gated_data_redo[i])) 

  FMO_gated_df_redo <- rbind(FMO_gated_df_redo, FMO_data_redo)
}

# when I redid the FMOs, I used lowercase for naming Zombie, so must convert to uppercase to match the previous samples
FMO_gated_df_redo <- FMO_gated_df_redo %>%
  select(-SSC.B.H, - SSC.B.A) %>%
  dplyr::rename("Zombie.NIR.A" = "Zombie.Nir.A",
         "Zombie.NIR.H" = "Zombie.Nir.H")

# combine the new and old FMOs
FMO_gated_df <- rbind(FMO_gated_df, FMO_gated_df_redo)

# number of cells in all FMOs
nrow(FMO_gated_df)

```





Gating the sample data

I checked that all D30, D60, and D90 samples have Zombie and will run all the way through the gating when separated by day. Looking at the data, some of them are labeled Zombie NIR-A and Zombie Nir-A which means that they are not recognized as the same. - D90 has uncapitalized. I will need to read them in separately and then rename one of the two so that the cases match

```{r warning=FALSE, fig.height = 2, fig.width=2}

fcsFiles <- list.files("../data/flow/BCG_v_PBS/Tcell/", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
ncfs <- read.ncdfFlowSet(fcsFiles) 



# apply gating set
gs <- GatingSet(ncfs)

# gate the samples
gating(initial_gate, gs)

# Pull out the gated data
gated_data <- getData(gs, "live") %>% 
  as.flowSet() 

# read in the D90 data
D90_ws <- list.files("../data/flow/BCG_v_PBS", 
                     pattern = "AmyGating_intracellular_D90.csv", full = TRUE)

D90_initial_gate <- gatingTemplate(D90_ws, autostart = 1L) 

D90_fcsFiles <- list.files("../data/flow/BCG_v_PBS/Tcell/D90", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
D90_ncfs <- read.ncdfFlowSet(D90_fcsFiles) 

# apply gating set
D90_gs <- GatingSet(D90_ncfs)

# gate the samples
gating(D90_initial_gate, D90_gs)

# Pull out the data
D90_gated_data <- getData(D90_gs, "live") %>% 
  as.flowSet() 

# initialize the gated data df
all_gated_df = data.frame()

# convert the gated flow files to dataframes and add a filename column
for (i in 1:length(gated_data)) {
  all_data <- gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(gated_data[i])) 

  all_gated_df <- rbind(all_gated_df, all_data)
}

# initialize the D90 gated data df
D90_all_gated_df = data.frame()

# convert the gated flow files to dataframes and add a filename column
for (i in 1:length(D90_gated_data)) {
  D90_all_data <- D90_gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(D90_gated_data[i])) 

  D90_all_gated_df <- rbind(D90_all_gated_df, D90_all_data)
}

# remove parameters that are not found in D30 and D60 data and rename the D90 Zombie column
D90_all_gated_df <- D90_all_gated_df %>%
  select(Time, SSC.H, FSC.H, ends_with(".A"), 
         `FSC.A`, `SSC.A`, -`SSC.B.A`, filename) %>%
  rename("Zombie.NIR.A" = "Zombie.Nir.A")

# combine the D30, D60, and D90 data into 1 dataframe
all_gated_df <- rbind(all_gated_df, D90_all_gated_df)

# number of data cells
nrow(all_gated_df)

gating_time_end <- Sys.time()

# time it takes to perform gating on the data
gating_time_end-gating_time_start
```

Pull out the individual FMOS
```{r}

CD3_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD3_20190218_153937_Unmixed.fcs")

CD4_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD4_June_6_Redo_Unmixed.fcs")

CD8_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD8_20190218_154138_Unmixed.fcs")

CD27_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD27_20190218_154154_Unmixed.fcs")

CD28_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD28_20190218_154012_Unmixed.fcs")

CD44_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD44_20190218_154054_Unmixed.fcs")

CD62L_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD62L_20190218_153953_Unmixed.fcs") 

CD69_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD69_June_6_Redo_Unmixed.fcs")

CD103_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD103_20190218_154045_Unmixed.fcs")

CD122_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD122_20190218_154003_Unmixed.fcs")

CD153_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD153_20190218_154205_Unmixed.fcs")

CTLA4_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CTLA4_20190218_154146_Unmixed.fcs")

FoxP3_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_FoxP3_20190218_154037_Unmixed.fcs") 

IFN_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IFN-G_20190218_154029_Unmixed.fcs")

IL_10_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IL-10_20190218_154102_Unmixed.fcs") 

IL_17_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IL-17_20190218_153945_Unmixed.fcs")

KLRG1_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_KLRG1_20190218_154214_Unmixed.fcs") 

PD1_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_PD1_20190218_154021_Unmixed.fcs")

Sca1_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_Sca1_20190218_153845_Unmixed.fcs")

TNF_FMO <- FMO_gated_df %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_TNF-a_20190218_154111_Unmixed.fcs")
```

Feature cut the data to get all of the possible populations for each file with the cell count and number of cells. Feature engineering is based on the 99%.

Remove FoxP3
Remove CD69 - spreading from Sca1 makes the marker unusable
Remove D30 PBS D - flow cytometry outlier, both within group, timepoint, and all samples
```{r}

all_gated <- all_gated_df %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 

```


Data visualization

We first want to view all of the different cell phenotypes within the data, and then we can filter the data to see the ones that we're interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.

```{r fig.height = 2.25, fig.width = 1.75}
# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE)

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))


```


Want to add annotations to the phenotype plot

- lineage
- cell
- resident

based on expression of different markers. The phenotype plot is then arranged by lineage, cell and resident cells and split by the lineage (I should try to find a way to do this automatically).

```{r}

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot,  gaps_row = c(17, 29, 35),
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)
```


```{r}
end_time <- Sys.time()
end_time - start_time
```

If want to count the number of cells at each stage

```{r}

# initial cell count for D90
gated_df_count <- data_frame()
for (i in 1:length(D90_ncfs)) {
  data_count <- D90_ncfs[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(D90_ncfs[i])) 

  gated_df_count <- rbind(gated_df_count, data_count)
}
```

## Test different input cell counts

10,000 cells
```{r}

start_time_10E3 <- Sys.time()

all_gated <- all_gated_df[1:10000, ] %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 


# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE)

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot, 
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)


end_time_10E3 <- Sys.time()

time_10E3 <- end_time_10E3 - start_time_10E3
```

50,000 cells
```{r}

start_time_5_10E3 <- Sys.time()

all_gated <- all_gated_df[1:50000, ] %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 


# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE)

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot,  
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)


end_time_5_10E3 <- Sys.time()

time_5_10E3 <- end_time_5_10E3 - start_time_5_10E3
```



100,000 cells
```{r}

start_time_10E4 <- Sys.time()

all_gated <- all_gated_df[1:100000, ] %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 


# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE)

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot, 
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)


end_time_10E4 <- Sys.time()

time_10E4 <- end_time_10E4 - start_time_10E4

```

500,000 cells
```{r}

start_time_5_10E4 <- Sys.time()

all_gated <- all_gated_df[1:500000, ] %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 


# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE)

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot,  
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)


end_time_5_10E4 <- Sys.time()

time_5_10E4 <-end_time_5_10E4 - start_time_5_10E4
```



1,000,000 cells
```{r}

start_time_10E5 <- Sys.time()

all_gated <- all_gated_df[1:1000000, ] %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 


# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE)

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# these are the colors I want for the pheatmap annotations
my_colors <- list(lineage = c(`Double Negative` = "darkturquoise", 
                              `T Helper` = "plum3",
                              `Cytotoxic T` = "hotpink",
                              `Double Positive` = "orange"),
                  cell = c(`Central Mem` = "darkorchid1", `Effector` = "#F8766D",
                `TSCM` = "#00B0F6", `Unknown` = "yellow"),
                resident = c(`Resident`  = "maroon2", `Non-resident` = "azure"))

# take the filtered data and add annotations for the differnt lineages, cell type, and resident status
phenotype_data <- sample_populations %>%
  mutate_all(~as.numeric.factor(.)) %>%
      mutate(lineage = ifelse(CD4 == 0 & CD8 ==0, "Double Negative",
                          ifelse(CD4 == 1 & CD8 ==0,"T Helper",
                          ifelse(CD4 ==0 & CD8 ==1, "Cytotoxic T", 
                                 "Double Positive")))) %>%
  mutate(cell = ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 1, "TSCM", 
                       ifelse(CD44 ==1 & CD62L==0, "Effector", 
                              ifelse(CD44 == 0 & CD62L == 1 & Sca1 == 0, "Naive",
                                     ifelse(CD44==1 & CD62L ==1, "Central Mem",
                                     "Unknown"))))) %>%
  mutate(resident = ifelse(CD103 == 1, "Resident", "Non-resident")) %>%
  select(lineage, cell, resident, CD3, CD4, CD8, CD44, CD62L, Sca1, CD103,  CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  arrange(match(lineage, c("Double Negative", "T Helper", "Cytotoxic T", "Double Positive")), cell, resident) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# create an annotated data frame to add to pheatmap
phenotype_annot <- phenotype_data %>%
  select(resident, cell, lineage) %>%
  mutate(population = c(paste0("Pop", 1: nrow(sample_populations)))) %>%
  column_to_rownames("population")

# plot the data with different annotations
pheatmap(phenotype_data[, 4:21], cluster_rows = FALSE, cluster_cols = FALSE,
           labels_row = paste("Pop", 1:nrow(sample_populations)), 
           annotation_row = phenotype_annot,  
           cellwidth = 15, cellheight = 15, angle_col = 45, annotation_colors = my_colors,
         color = viridis_colors, cutree_rows = 2)


end_time_10E5 <- Sys.time()

time_10E5 <- end_time_10E5 - start_time_10E5
```

```{r}
combine_time <- data_frame(Cells = c(10000, 50000, 100000, 500000, 1000000), Time = c(time_10E3, time_5_10E3,  time_10E4, time_5_10E4, time_10E5))

ggplot(combine_time, aes(Cells, Time)) +
  geom_point() +
  geom_line() +
  labs(x = "Number of Cells", y = "Running Time (seconds)") +
  theme_bw()
```

```{r}
BiocManager::valid()
```