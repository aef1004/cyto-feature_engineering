---
title: "Sensitivity_analysis"
author: "Amy Fox"
date: "3/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, the packages must be loaded.

```{r warning= FALSE, message = FALSE}
library(openCyto)
library(data.table)
library(flowCore)
library(ggcyto)
library(pheatmap)
library(stringr)
library(readxl)
library(gridExtra)
library(ggcorrplot)
library(tidyverse)
library(scales)
library(viridis)
library(superheat)
library(kableExtra)
library(ggpubr)
library(broom)
library(jpeg)
```

I have created a few functions to make it easier to analyze the data.

- `clean_FMO_after_gate`: renames the columns; it also removes SSC boundary effects

- `statSmoothFunc`: modified from <https://gist.github.com/kdauria/524eade46135f6348140> to add $r^2$ to correlation plots to correlation plots [Amy, for these modified functions, we should consider giving them different names, so that if we put these in a package and someone else loads this and the package with the original function, there won't be conflicts from two functions from separate packages having the same name. Maybe add `corr` or `r2` to the end of the functoin names?]

- `stat_smooth_func`: modified from <https://gist.github.com/kdauria/524eade46135f6348140> pull out $r^2$ for correlation plots [Amy, For this and the previous function, do you think it would be easier for us to create these modified versions by adding a `geom_text` or `geom_label` line to a ggplot object, instead, rather than changing the geoms for the smooth functions?]

- `as.numeric.factor`: convert the factors for the marker names into numeric for plotting [Amy: Why won't `as.numeric` work for this? That's a base R function that might avoid having to create this new function.]

- `viridis_colors`: vector of the colors used for most plots


```{r}

clean_FMO_after_gate <- function(FMO_df) {
  FMO_df %>%
  select(ends_with("-A"), -`FSC-A`, `SSC-A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC-A",
         `CD44` = "APC-Fire 750-A",
        `CD103` =  "APC-R700-A",       
         `CD3` = "Alexa Fluor 532-A",
         `Sca1` = "BB515-A",
         `IL_10` = "BV421-A",
         `CD4` = "BV480-A",
         `CD69` = "BV510-A",
         `CD8` = "BV570-A", 
         `CTLA4` = "BV605-A",
         `CD27` = "BV650-A",
         `CD153` = "BV711-A",
         `KLRG1` = "BV785-A",
         `IL_17` = "PE-A",
         `CD122` = "PE-Cy5-A",
         `IFN` = "PE-Cy7-A", 
         `CD62L` = "PE-Dazzle594-A",
         `TNF` = "Pacific Blue-A", 
         `CD28` = "PE-Cy5.5-A",
         `PD1` = "PerCP-eFluor 710-A")  %>%
   na.omit()%>%
  dplyr::filter(`SSC-A` != max(`SSC-A`))

}


# taken from https://gist.github.com/kdauria/524eade46135f6348140
stat_smooth_func <- function(mapping = NULL, data = NULL,
                        geom = "smooth", position = "identity",
                        ...,
                        method = "auto",
                        formula = y ~ x,
                        se = TRUE,
                        n = 80,
                        span = 0.75,
                        fullrange = FALSE,
                        level = 0.95,
                        method.args = list(),
                        na.rm = FALSE,
                        show.legend = NA,
                        inherit.aes = TRUE,
                        xpos = NULL,
                        ypos = NULL) {
  layer(
    data = data,
    mapping = mapping,
    stat = StatSmoothFunc,
    geom = geom,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      method = method,
      formula = formula,
      se = se,
      n = n,
      fullrange = fullrange,
      level = level,
      na.rm = na.rm,
      method.args = method.args,
      span = span,
      xpos = xpos,
      ypos = ypos,
      ...
    )
  )
}

StatSmoothFunc <- ggproto("StatSmooth", Stat,
                      
                      setup_params = function(data, params) {
                        # Figure out what type of smoothing to do: loess for small datasets,
                        # gam with a cubic regression basis for large data
                        # This is based on the size of the _largest_ group.
                        if (identical(params$method, "auto")) {
                          max_group <- max(table(data$group))
                          
                          if (max_group < 1000) {
                            params$method <- "loess"
                          } else {
                            params$method <- "gam"
                            params$formula <- y ~ s(x, bs = "cs")
                          }
                        }
                        if (identical(params$method, "gam")) {
                          params$method <- mgcv::gam
                        }
                        
                        params
                      },
                      
                      compute_group = function(data, scales, method = "auto", formula = y~x,
                                               se = TRUE, n = 80, span = 0.75, fullrange = FALSE,
                                               xseq = NULL, level = 0.95, method.args = list(),
                                               na.rm = FALSE, xpos=NULL, ypos=NULL) {
                        if (length(unique(data$x)) < 2) {
                          # Not enough data to perform fit
                          return(data.frame())
                        }
                        
                        if (is.null(data$weight)) data$weight <- 1
                        
                        if (is.null(xseq)) {
                          if (is.integer(data$x)) {
                            if (fullrange) {
                              xseq <- scales$x$dimension()
                            } else {
                              xseq <- sort(unique(data$x))
                            }
                          } else {
                            if (fullrange) {
                              range <- scales$x$dimension()
                            } else {
                              range <- range(data$x, na.rm = TRUE)
                            }
                            xseq <- seq(range[1], range[2], length.out = n)
                          }
                        }
                        # Special case span because it's the most commonly used model argument
                        if (identical(method, "loess")) {
                          method.args$span <- span
                        }
                        
                        if (is.character(method)) method <- match.fun(method)
                        
                        base.args <- list(quote(formula), data = quote(data), weights = quote(weight))
                        model <- do.call(method, c(base.args, method.args))
                        
                        m = model
                        eq <- substitute(~~italic(r)^2~"="~r2, 
                                         list(a = format(coef(m)[1], digits = 3), 
                                              b = format(coef(m)[2], digits = 3), 
                                              r2 = format(summary(m)$r.squared, digits = 3)))
                        func_string = as.character(as.expression(eq))
                        
                        if(is.null(xpos)) xpos = min(data$x)*0.9
                        if(is.null(ypos)) ypos = max(data$y)*0.9
                        data.frame(x=xpos, y=ypos, label=func_string)
                        
                      },
                      
                      required_aes = c("x", "y")
)

viridis_colors <- c("#3F4788FF", "#56C667FF")


as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

```

## Initial gating of FMOs

Read in the initial gating strategy, which gates to live lymphocytes, into a `gatingTemplate` class.

```{r}
# Identify the file with the gating strategy 
ws <- list.files("../Data/flow/BCG_v_PBS", 
                 pattern = "AmyGating_intracellular.csv", 
                 full = TRUE)
ws
```

```{r}
# View this template
dtTemplate <- fread(ws)
dtTemplate
```

```{r message = FALSE, warning = FALSE}
# Read in the gating strategy to a 'gatingTemplate' object
initial_gate <- gatingTemplate(ws) 
plot(initial_gate)
```

Read in the flow cytometry data from the FMO experiments.

```{r}
# Identify the file names of all 20 FCS flow cytometry experiments to 
# read in. 
FMO_fcsFiles <- list.files("../Data/flow/BCG_v_PBS/Tcell/FMOs", 
                       pattern = ".fcs", full = TRUE)
FMO_fcsFiles
```

```{r}
# Read these files into a 'ncdfFlowSet' object. This will taken a minute
# or so to run. The resulting 'ncdfFlowset' object contains row names with the 
# individual samples and column names with the markers/parameters used in the flow cytometer.
ncfs_FMO <- read.ncdfFlowSet(FMO_fcsFiles) 
ncfs_FMO
```

Apply the initial gating to filter the data to only measurements on live lymphocyte cells.

```{r}
# Convert to a 'GatingSet' object, so we can apply the initial gating to this data.
gs_FMO <- GatingSet(ncfs_FMO)
gs_FMO
```

```{r fig.height = 8, fig.width = 4}
# Apply the initial gating to this data, to filter to only measurements
# on live lymphocyte cells. This may take a minute.
gt_gating(initial_gate, gs_FMO)

# You can plot the results of this gating with `plotGate`. For example, to plot
# the gating for the first sample, run:
plotGate(gs_FMO[[1]])
```

## Convert data to "tidy data" format

Now that the initial gating has been applied, to limit the data to measurements oflive, singlet lymphocyte cells, we convert the data to a "tidy data" format, to allow us to work with "tidyverse" tools for further analysis and visualization.

```{r}
# Pull out the data from the 'live' node of the gating set (the last node
# in the initial gating strategy).
FMO_gated_data <- getData(gs_FMO, "live") %>% 
  as.flowSet() 

# Write a function to extract data from an item of a 'flowSet' object
library(tibble)
tidy_flow_item <- function(flowSet_item){
  flowSet_item %>% 
    Biobase::exprs() %>% 
    tibble::as_tibble()
}

# Create a function that applies this to all items in a 'flowSet' object
tidy_flow_set <- function(flowSet){
  flow_set <- flowCore::fsApply(x = flowSet, 
                                FUN = tidy_flow_item)
  flow_set <- dplyr::bind_rows(flow_set, .id = "filename")
}
```

Apply this function to the 'flowSet' of gated FMO data:

```{r}
FMO_gated_data <- tidy_flow_set(FMO_gated_data)
FMO_gated_data
```


```{r}
# confirm that all of the files were read in correctly
unique(FMO_gated_data$filename)
```

[Let's clean up this file so we don't have redos, instead just a clean flow
through our final code.]

```{r}
# I accidently got CD4 into the CD4 FMO, so I had to redo it. I also tried CD69 to see if it was experiment-dependent, but CD69 problems are due to spillover

# Add in the updated FMOS
FMO_fcsFiles_redo <- list.files("../Data/flow/BCG_v_PBS/Tcell/FMOs/June6_Redo", 
                       pattern = ".fcs", full = TRUE)

ncfs_FMO_redo <- read.ncdfFlowSet(FMO_fcsFiles_redo) 

# apply gating set
gs_FMO_redo <- GatingSet(ncfs_FMO_redo)

# gate the samples
gt_gating(initial_gate, gs_FMO_redo)

# Pull out the data
FMO_gated_data_redo <- getData(gs_FMO_redo, "live") %>% 
  as.flowSet() 

FMO_gated_df_redo <- tidy_flow_set(FMO_gated_data_redo)
```


```{r}
# when I redid the FMOs, I used lowercase for naming Zombie, so must convert to uppercase to match the previous samples
FMO_gated_df_redo <- FMO_gated_df_redo %>%
  dplyr::select(-`SSC-B-H`, - `SSC-B-A`) %>%
  dplyr::rename("Zombie NIR-A" = "Zombie Nir-A",
         "Zombie NIR-H" = "Zombie Nir-H")

# combine the new and old FMOs
FMO_gated_data <- rbind(FMO_gated_data, FMO_gated_df_redo)

```

This visualization is to look at the initial gating of the FMOs to ensure that the gates are placed correctly.
```{r fig.height = 8, fig.width = 4}
plotGate(gs_FMO[[3]])
```

Pull out the individual FMOS

```{r}

CD3_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD3_20190218_153937_Unmixed.fcs")

CD4_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD4_June_6_Redo_Unmixed.fcs")

CD8_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD8_20190218_154138_Unmixed.fcs")

CD27_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD27_20190218_154154_Unmixed.fcs")

CD28_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD28_20190218_154012_Unmixed.fcs")

CD44_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD44_20190218_154054_Unmixed.fcs")

CD62L_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD62L_20190218_153953_Unmixed.fcs") 

CD69_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD69_June_6_Redo_Unmixed.fcs")

CD103_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD103_20190218_154045_Unmixed.fcs")

CD122_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD122_20190218_154003_Unmixed.fcs")

CD153_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CD153_20190218_154205_Unmixed.fcs")

CTLA4_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_CTLA4_20190218_154146_Unmixed.fcs")

FoxP3_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_FoxP3_20190218_154037_Unmixed.fcs") 

IFN_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IFN-G_20190218_154029_Unmixed.fcs")

IL_10_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IL-10_20190218_154102_Unmixed.fcs") 

IL_17_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_IL-17_20190218_153945_Unmixed.fcs")

KLRG1_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_KLRG1_20190218_154214_Unmixed.fcs") 

PD1_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_PD1_20190218_154021_Unmixed.fcs")

Sca1_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_Sca1_20190218_153845_Unmixed.fcs")

TNF_FMO <- FMO_gated_data %>%
  clean_FMO_after_gate() %>%
  dplyr::filter(filename == "FMOs_TNF-a_20190218_154111_Unmixed.fcs")
```

Feature engineering FMOs and plot

```{r fig.width = 8, fig.height= 6 warning=FALSE}
p1 <-  ggplot(CD3_FMO, aes(x = CD3, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD3_FMO$CD3, 0.99)) +
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p2 <- ggplot(CD4_FMO, aes(x = CD4, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD4_FMO$CD4, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p3 <- ggplot(CD8_FMO, aes(x = CD8, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD8_FMO$CD8, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

# this plot is removed because we are not going to be using this marker
p4 <- ggplot(FoxP3_FMO, aes(x = FoxP3, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(FoxP3_FMO$FoxP3, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p5 <- ggplot(CD27_FMO, aes(x = CD27, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD27_FMO$CD27, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p6 <- ggplot(CD28_FMO, aes(x = CD28, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD28_FMO$CD28, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p7 <- ggplot(CD44_FMO, aes(x = CD44, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD44_FMO$CD44, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p8 <- ggplot(IL_10_FMO, aes(x = IL_10, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(IL_10_FMO$IL_10, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p9 <- ggplot(CD62L_FMO, aes(x = CD62L, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
   ylab("") +
   geom_vline(xintercept = quantile(CD62L_FMO$CD62L, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

# this plot is removed because we are not going to be using this marker
p10 <- ggplot(CD69_FMO, aes(x = CD69, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD69_FMO$CD69, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p11 <- ggplot(CD103_FMO, aes(x = CD103, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD103_FMO$CD103, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p12 <- ggplot(CD122_FMO, aes(x = CD122, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD122_FMO$CD122, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p13 <- ggplot(CD153_FMO, aes(x = CD153, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CD153_FMO$CD153, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p14 <- ggplot(CTLA4_FMO, aes(x = CTLA4, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(CTLA4_FMO$CTLA4, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p15 <- ggplot(IL_17_FMO, aes(x = IL_17, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(IL_17_FMO$IL_17, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p16 <- ggplot(IFN_FMO, aes(x = IFN, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(IFN_FMO$IFN, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p17 <- ggplot(TNF_FMO, aes(x = TNF, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(TNF_FMO$TNF, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


p18 <- ggplot(KLRG1_FMO, aes(x = KLRG1, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(KLRG1_FMO$KLRG1, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p19 <- ggplot(PD1_FMO, aes(x = PD1, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(PD1_FMO$PD1, 0.99))+
  theme_gray()+
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20))+
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))

p20 <- ggplot(Sca1_FMO, aes(x = Sca1, y = `SSC-A`)) +
   geom_hex(bins = 100, na.rm = TRUE) +
   scale_fill_viridis_c() +
  ylab("") +
   geom_vline(xintercept = quantile(Sca1_FMO$Sca1, 0.99))+
  theme_gray() +
  theme(axis.text = element_text(size =12),
        axis.title = element_text(size = 20)) +
  scale_x_continuous(labels = scientific, limits = c(-10000, 20000), breaks = c(-10000, 0, 20000))


library(grid)
grid.arrange(p1, p2, p3, p5, p6, p7, p8, p9,
             p11, p12, p13, p14, p15, p16, p17, p18, p19, p20, 
             nrow = 5, left = textGrob("SSC-A", rot = 90, vjust = 1, gp=gpar(fontsize=24, lineheight=1)))
```

Gating the sample data

I checked that all D30, D60, and D90 samples have Zombie and will run all the way through the gating when separated by day. Looking at the data, some of them are labeled Zombie NIR-A and Zombie Nir-A which means that they are not recognized as the same. - D90 has uncapitalized. I will need to read them in separately and then rename one of the two so that the cases match

```{r warning=FALSE, fig.height = 2, fig.width=2}

fcsFiles <- list.files("../Data/flow/BCG_v_PBS/Tcell/", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
ncfs <- read.ncdfFlowSet(fcsFiles) 

# apply gating set
gs <- GatingSet(ncfs)

# gate the samples
gt_gating(initial_gate, gs)

# View the gates
plotGate(gs[[12]])





# Pull out the gated data
gated_data <- getData(gs, "live") %>% 
  as.flowSet() 


# read in the D90 data
D90_ws <- list.files("../Data/flow/BCG_v_PBS", 
                     pattern = "AmyGating_intracellular_D90.csv", full = TRUE)

D90_initial_gate <- gatingTemplate(D90_ws, autostart = 1L) 

D90_fcsFiles <- list.files("../Data/flow/BCG_v_PBS/Tcell/D90", 
                       pattern = ".fcs", full = TRUE)

# ncdfFlowset object contains row names with the individual samples and column names with the markers/parameters used in the flow cytometer
D90_ncfs <- read.ncdfFlowSet(D90_fcsFiles) 

# apply gating set
D90_gs <- GatingSet(D90_ncfs)

# gate the samples
gt_gating(D90_initial_gate, D90_gs)

# Pull out the data
D90_gated_data <- getData(D90_gs, "live") %>% 
  as.flowSet() 

# initialize the gated data df
all_gated_df = data.frame()

# convert the gated flow files to dataframes and add a filename column
for (i in 1:length(gated_data)) {
  all_data <- gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(gated_data[i])) 

  all_gated_df <- rbind(all_gated_df, all_data)
}

# initialize the D90 gated data df
D90_all_gated_df = data.frame()

# convert the gated flow files to dataframes and add a filename column
for (i in 1:length(D90_gated_data)) {
  D90_all_data <- D90_gated_data[[i]] %>%
    exprs() %>%
    data.frame() %>%
    mutate(filename = sampleNames(D90_gated_data[i])) 

  D90_all_gated_df <- rbind(D90_all_gated_df, D90_all_data)
}

# remove parameters that are not found in D30 and D60 data and rename the D90 Zombie column
D90_all_gated_df <- D90_all_gated_df %>%
  select(Time, SSC.H, FSC.H, ends_with(".A"), 
         `FSC.A`, `SSC.A`, -`SSC.B.A`, filename) %>%
  rename("Zombie.NIR.A" = "Zombie.Nir.A")

# combine the D30, D60, and D90 data into 1 dataframe
all_gated_df <- rbind(all_gated_df, D90_all_gated_df)

# confirm that all of the data is here
unique(all_gated_df$filename)

ggcyto(gs[[3]], aes(x = `FSC.A`, y = `FSC.H`)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis_c() +
  xlim(-100, 4000000) +
  geom_gate("singlets") +
  xlab("FSC-A") +
  ylab("FSC-H") +
  ggtitle("Singlets") +
  theme_gray() +
  geom_stats() + 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))

ggcyto(gs[[3]], aes(x = `FSC-A`, y = `SSC-A`)) + 
  geom_hex(bins = 50) + 
  scale_fill_viridis_c() +
  geom_gate("lymph") +
  ylim(c(-100, 4000000)) + 
  xlab("FSC-A") +
  ylab("SSC-A") +
  ggtitle("Leukocytes") +
  theme_gray() +
  geom_stats()+ 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))

ggcyto(gs[[3]], aes(x = `Zombie Nir-A`)) + 
  geom_density() + 
  geom_gate("live") + 
  xlim(-100,50000) + 
  xlab("Zombie NIR-A") +
  ylab("Density") +
  ggtitle("Live") +
  theme_gray() +
  geom_stats() +
  labs_cyto("both") + 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))


# problem with plotting - it cuts off the data instead of making the entire x-axis shorter
ggcyto(gs[[3]], aes(x = `Zombie Nir-A`)) + 
  geom_density() + 
  geom_gate("live")  +
  xlab("Zombie NIR-A") +
  ylab("Density") +
  ggtitle("Live") +
  theme_gray() +
  geom_stats() +
  labs_cyto("both") + 
  theme(strip.text = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 20),
        title = element_text(size = 20))
```

Feature cut the data to get all of the possible populations for each file with the cell count and number of cells. Feature engineering is based on the 99%.

# FMO 99%
Remove FoxP3
Remove CD69 - spreading from Sca1 makes the marker unusable
Remove D30 PBS D - flow cytometry outlier, both within group, timepoint, and all samples
```{r}

all_gated <- all_gated_df %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, 0.99), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, 0.99), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, 0.99), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, 0.99),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, 0.99),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, 0.99),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, 0.99),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, 0.99),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, 0.99),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, 0.99),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, 0.99), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, 0.99), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, 0.99), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, 0.99), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, 0.99), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, 0.99), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, 0.99),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, 0.99),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, 0.99),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, 0.99),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 

```

Data visualization

We first want to view all of the different cell phenotypes within the data, and then we can filter the data to see the ones that we're interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.

```{r fig.height = 2.25, fig.width = 1.75}
# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

supp_2 <-pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE, legend = F, fontsize = 6, angle_col = 45, width = 2, height = 1.5) 

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# number of CD3+ populations >0.5%
nrow(sample_populations)
```

## FMO @ 98%

Remove FoxP3
Remove CD69 - spreading from Sca1 makes the marker unusable
Remove D30 PBS D - flow cytometry outlier, both within group, timepoint, and all samples
```{r}
quant <- 0.98

all_gated <- all_gated_df %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, quant), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, quant), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, quant), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, quant),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, quant),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, quant),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, quant),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, quant),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, quant),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, quant),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, quant), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, quant), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, quant), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, quant), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, quant), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, quant), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, quant),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, quant),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, quant),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, quant),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 

```

Data visualization

We first want to view all of the different cell phenotypes within the data, and then we can filter the data to see the ones that we're interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.

```{r fig.height = 2.25, fig.width = 1.75}
# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

supp_2 <-pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE, legend = F, fontsize = 6, angle_col = 45, width = 2, height = 1.5) 

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# number of CD3+ populations >0.5%
nrow(sample_populations)
```



## FMO @ 95%

```{r}
quant <- 0.95

all_gated <- all_gated_df %>%
  dplyr::filter(filename != "D30_Lung_Group 1 D_20190218_153300_Unmixed.fcs") %>%
  mutate(Time = str_extract(filename, "D[0-9]*")) %>%
  mutate(Group = str_extract(filename, "Group\\s[0-9]\\s[A-Z]")) %>%
  unite(filename, c("Time", "Group")) %>%
  mutate(filename= str_replace_all(filename, "\\s", "_")) %>%
  select(ends_with(".A"), -`FSC.A`, filename) %>%
  dplyr::rename(`FoxP3` = "APC.A",
         `CD44` = "APC.Fire.750.A",
        `CD103` =  "APC.R700.A",       
         `CD3` = "Alexa.Fluor.532.A",
         `Sca1` = "BB515.A",
         `IL_10` = "BV421.A",
         `CD4` = "BV480.A",
         `CD69` = "BV510.A",
         `CD8` = "BV570.A", 
         `CTLA4` = "BV605.A",
         `CD27` = "BV650.A",
         `CD153` = "BV711.A",
         `KLRG1` = "BV785.A",
         `IL_17` = "PE.A",
         `CD122` = "PE.Cy5.A",
         `IFN` = "PE.Cy7.A", 
         `CD62L` = "PE.Dazzle594.A",
         `TNF` = "Pacific.Blue.A", 
         `CD28` = "PE.Cy5.5.A",
         `PD1` = "PerCP.eFluor.710.A") %>%
  na.omit() %>%
  dplyr::filter(`SSC.A` != max(`SSC.A`)) %>%
  mutate(CD3 = cut(CD3, breaks = c(min(CD3), quantile(CD3_FMO$CD3, quant), max(CD3)), 
                       labels = c("0", "1")),
         CD4 = cut(CD4, breaks = c(min(CD4), quantile(CD4_FMO$CD4, quant), max(CD4)),
                       labels = c(0, 1)),
         CD8 = cut(CD8, breaks = c(min(CD8), quantile(CD8_FMO$CD8, quant), max(CD8)),
                       labels = c(0, 1)),
         CD44 = cut(CD44, breaks = c(min(CD44), quantile(CD44_FMO$CD44, quant),
                                         max(CD44)), labels = c(0, 1)),
         CD103 = cut(CD103, breaks = c(min(CD103), quantile(CD103_FMO$CD103, quant),
                                           max(CD103)), labels = c(0, 1)),
         Sca1 = cut(Sca1, breaks = c(min(Sca1), quantile(Sca1_FMO$Sca1, quant),
                                         max(Sca1)), labels = c(0, 1)),
         IL_17 = cut(IL_17, breaks = c(min(IL_17), quantile(IL_17_FMO$IL_17, quant),
                                         max(IL_17)),labels = c(0, 1)),
         CD69 = cut(CD69, breaks = c(min(CD69), quantile(CD69_FMO$CD69, quant),
                                         max(CD69)),labels = c(0, 1)),
         CTLA4 = cut(CTLA4, breaks = c(min(CTLA4), quantile(CTLA4_FMO$CTLA4, quant),
                                           max(CTLA4)),labels = c(0, 1)),
         CD27 = cut(CD27, breaks = c(min(CD27), quantile(CD27_FMO$CD27, quant),
                                         max(CD27)), labels = c(0, 1)),
         CD153 = cut(CD153, breaks = c(min(CD153), quantile(CD153_FMO$CD153, quant), 
                                           max(CD153)),labels = c(0, 1)),
         KLRG1 = cut(KLRG1, breaks = c(min(KLRG1), quantile(KLRG1_FMO$KLRG1, quant), 
                                           max(KLRG1)), labels = c(0, 1)),
         IFN = cut(IFN, breaks = c(min(IFN), quantile(IFN_FMO$IFN, quant), 
                                           max(IFN)), labels = c(0, 1)),
         FoxP3 = cut(FoxP3, breaks = c(min(FoxP3), quantile(FoxP3_FMO$FoxP3, quant), 
                                           max(FoxP3)), labels = c(0, 1)),
         CD122 = cut(CD122, breaks = c(min(CD122), quantile(CD122_FMO$CD122, quant), 
                                           max(CD122)), labels = c(0, 1)),
         PD1 = cut(PD1, breaks = c(min(PD1), quantile(PD1_FMO$PD1, quant), 
                                       max(PD1)), labels = c(0, 1)),
         CD62L = cut(CD62L, breaks = c(min(CD62L), quantile(CD62L_FMO$CD62L, quant),
                                           max(CD62L)), labels = c(0, 1)),
         IL_10 = cut(IL_10, breaks = c(min(IL_10), 
                                             quantile(IL_10_FMO$IL_10, quant),
                                             max(IL_10)), labels = c(0, 1)),
         CD28 = cut(CD28, breaks = c(min(CD28), quantile(CD28_FMO$CD28, quant),
                                         max(CD28)), labels = c(0, 1)),
         TNF = cut(TNF, breaks = c(min(TNF), quantile(TNF_FMO$TNF, quant),
                                           max(TNF)), labels = c(0, 1))) %>%
  select(-Zombie.NIR.A, -AF.A, -SSC.A, -FoxP3, -CD69) %>%
  mutate_at(vars(-group_cols()), funs(tidyr::replace_na(.,0))) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF, filename) %>%
  dplyr::mutate(cell_no = n()) %>%
  unique() %>%
  ungroup() %>%
  dplyr::group_by(filename) %>%
  dplyr::mutate(total_count_by_file = sum(cell_no),
         percentage = (100*cell_no / total_count_by_file)) %>%
  ungroup() 

```

Data visualization

We first want to view all of the different cell phenotypes within the data, and then we can filter the data to see the ones that we're interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.

```{r fig.height = 2.25, fig.width = 1.75}
# to view all of the possible combinations
total_phenotypes <- all_gated %>%
    select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17,  CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
 select(CD3, CD4, CD8, CD44, CD62L, Sca1, CD103, CTLA4, CD27, CD122, CD153, CD28, PD1, KLRG1, IL_17, IL_10, IFN,  TNF) %>%
  mutate_all(~as.numeric.factor(.))

supp_2 <-pheatmap(total_phenotypes, cluster_rows = FALSE, cluster_cols = FALSE, 
         color = viridis_colors, show_rownames = FALSE, legend = F, fontsize = 6, angle_col = 45, width = 2, height = 1.5) 

# gives the total number of populations
nrow(total_phenotypes) 

# view the specific cell phenotypes we're interested in
sample_populations <- all_gated %>%
  dplyr::filter(CD3 == 1 & percentage > 0.5) %>%
  select(-filename, -percentage, -cell_no, -total_count_by_file) %>%
  group_by(CD3, CD4, CD8, CD44, CD103, Sca1, IL_17, CTLA4, CD27, 
           CD153, KLRG1, IFN,  CD122, PD1, CD62L, IL_10, CD28,
           TNF) %>%
  unique() %>%
  ungroup() %>%
  mutate(population = paste0("Pop", 1:length(CD3)))

# add in the percentage of cells in each specific population after the filter
test <- left_join(sample_populations, all_gated)

# expand to add in the data where a mouse may have 0 cells in a certain population identified after the filter
all_options <- expand(test, population, filename)

# add in the population information
add_pops <- left_join(all_options, sample_populations)

# add populations to the original gated data and replace NA percentages with 0
sample_populations_all_groups <- left_join(add_pops, all_gated) %>%
  select(population, filename, percentage) %>%
  mutate_all(funs(replace_na(., 0)))

# number of CD3+ populations >0.5%
nrow(sample_populations)
```
